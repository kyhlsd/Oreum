# Fastfile for Oreum

default_platform(:ios)

platform :ios do
  desc "Run tests"
  lane :test do
    # Tuist install and generate to create Xcode project
    sh("cd .. && tuist install && tuist generate")

    # Run tests
    run_tests(
      workspace: "Oreum.xcworkspace",
      scheme: "Domain",  # Use Domain scheme which includes DomainTests
      devices: ["iPhone 17 Pro"],
      clean: true,
      code_coverage: true
    )
  end

  desc "Build the app"
  lane :build do
    # Tuist install and generate to create Xcode project
    sh("cd .. && tuist install && tuist generate")

    # Build the app for verification
    xcodebuild(
      workspace: "Oreum.xcworkspace",
      scheme: "Oreum",
      configuration: "Debug",
      clean: true,
      build: true,
      destination: "generic/platform=iOS Simulator",
      xcargs: "CODE_SIGNING_ALLOWED=NO CODE_SIGNING_REQUIRED=NO"
    )
  end

  desc "Deploy to TestFlight"
  lane :beta do
    # Tuist install and generate to create Xcode project
    sh("cd .. && tuist install && tuist generate")

    # Get provisioning profile UUIDs from environment variables
    oreum_profile_uuid = ENV['OREUM_PROFILE_UUID']
    widget_profile_uuid = ENV['WIDGET_PROFILE_UUID']

    # Setup App Store Connect API Key
    api_key = app_store_connect_api_key(
      key_id: ENV['APP_STORE_CONNECT_API_KEY_ID'],
      issuer_id: ENV['APP_STORE_CONNECT_API_ISSUER_ID'],
      key_filepath: "~/.appstoreconnect/private_keys/AuthKey_#{ENV['APP_STORE_CONNECT_API_KEY_ID']}.p8",
      in_house: false
    )

    # Get latest build number from App Store Connect and increment
    latest_build_number = app_store_build_number(
      app_identifier: "com.kyh.Oreum",
      live: false,
      api_key: api_key
    )
    new_build_number = latest_build_number + 1

    UI.message("Latest build number: #{latest_build_number}")
    UI.message("New build number: #{new_build_number}")

    # Update code signing settings for each target
    update_code_signing_settings(
      use_automatic_signing: false,
      path: "Oreum.xcodeproj",
      targets: ["Oreum"],
      code_sign_identity: "Apple Distribution",
      bundle_identifier: "com.kyh.Oreum",
      profile_uuid: oreum_profile_uuid,
      build_configurations: ["Release"]
    )

    update_code_signing_settings(
      use_automatic_signing: false,
      path: "Oreum.xcodeproj",
      targets: ["OreumWidgetExtension"],
      code_sign_identity: "Apple Distribution",
      bundle_identifier: "com.kyh.Oreum.OreumWidget",
      profile_uuid: widget_profile_uuid,
      build_configurations: ["Release"]
    )

    # Build and upload to TestFlight
    build_app(
      workspace: "Oreum.xcworkspace",
      scheme: "Oreum",
      configuration: "Release",
      export_method: "app-store",
      clean: true,
      xcargs: "CURRENT_PROJECT_VERSION=#{new_build_number}",
      export_options: {
        method: "app-store",
	teamID: "4QUWH828P3",
        signingStyle: "manual",
        provisioningProfiles: {
          "com.kyh.Oreum" => oreum_profile_uuid,
          "com.kyh.Oreum.OreumWidget" => widget_profile_uuid
        }
      }
    )

    upload_to_testflight(
      skip_waiting_for_build_processing: true,
      apple_id: "6753770017",
      api_key: api_key
    )
  end
end
